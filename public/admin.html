<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facilitator Control Panel - Post-It Dunking</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .admin-panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .control-group button {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px 0;
            transition: background 0.3s;
        }

        .control-group button:hover {
            background: #5568d3;
        }

        .control-group button.danger {
            background: #e74c3c;
        }

        .control-group button.danger:hover {
            background: #c0392b;
        }

        .control-group button.success {
            background: #27ae60;
        }

        .control-group button.success:hover {
            background: #229954;
        }

        .control-group select {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .basket-control {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .basket-control canvas {
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: crosshair;
            background: #f8f9fa;
        }

        .game-preview {
            background: #e9ecef;
            padding: 20px;
            border-radius: 10px;
        }

        .scoreboard-admin {
            max-height: 400px;
            overflow-y: auto;
        }

        .export-section {
            margin-top: 20px;
            padding: 15px;
            background: #d4edda;
            border-radius: 8px;
        }

        .export-section button {
            background: #28a745;
        }

        .export-section button:hover {
            background: #218838;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.active {
            background: #27ae60;
        }

        .status-indicator.inactive {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <header>
            <h1>üéØ Facilitator Control Panel</h1>
        </header>

        <div class="admin-panel">
            <h2>Round Controls</h2>
            <div class="controls-grid">
                <div class="control-group">
                    <label>Round Management</label>
                    <button id="startRoundBtn" class="success">Start Round</button>
                    <button id="stopRoundBtn" class="danger">Stop Round</button>
                    <div style="margin-top: 10px;">
                        <span class="status-indicator" id="roundStatusIndicator"></span>
                        <span id="roundStatusText">Round Inactive</span>
                    </div>
                </div>

                <div class="control-group">
                    <label>Current Rule</label>
                    <select id="ruleSelect">
                        <option value="Normal Throw">Normal Throw</option>
                        <option value="Turn Around and Throw">Turn Around and Throw</option>
                        <option value="Throw from Left Side">Throw from Left Side</option>
                        <option value="Throw from Right Side">Throw from Right Side</option>
                        <option value="Double Points Round">Double Points Round</option>
                        <option value="Basket Moves">Basket Moves</option>
                        <option value="360¬∞ Spin Before Throw">360¬∞ Spin Before Throw</option>
                    </select>
                    <button id="changeRuleBtn">Change Rule</button>
                </div>

                <div class="control-group">
                    <label>Score Management</label>
                    <button id="resetScoresBtn" class="danger">Reset All Scores</button>
                    <button id="exportScoresBtn" class="success">Export Scores (CSV)</button>
                </div>
            </div>
        </div>

        <div class="admin-panel">
            <h2>Basket Position Control</h2>
            <div class="basket-control">
                <p>Click and drag on the canvas below to move the basket:</p>
                <canvas id="basketCanvas" width="1000" height="400"></canvas>
            </div>
        </div>

        <div class="admin-panel">
            <h2>Live Game Preview</h2>
            <div class="game-preview">
                <canvas id="gamePreviewCanvas" width="1000" height="600"></canvas>
            </div>
        </div>

        <div class="admin-panel">
            <h2>Player Scoreboard</h2>
            <div id="adminScoreboard" class="scoreboard-admin"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let gameState = {
            players: new Map(),
            basket: { x: 700, y: 200, width: 150, height: 100 },
            roundActive: false,
            roundTimeLeft: 0,
            currentRule: 'Normal Throw'
        };

        // Canvas setup
        const basketCanvas = document.getElementById('basketCanvas');
        const basketCtx = basketCanvas.getContext('2d');
        const previewCanvas = document.getElementById('gamePreviewCanvas');
        const previewCtx = previewCanvas.getContext('2d');

        let isDraggingBasket = false;
        let dragOffset = { x: 0, y: 0 };

        // Draw basket on control canvas
        function drawBasketControl() {
            basketCtx.clearRect(0, 0, basketCanvas.width, basketCanvas.height);
            
            const basket = gameState.basket;
            
            // Basket backboard
            basketCtx.fillStyle = '#8B4513';
            basketCtx.fillRect(basket.x - 10, basket.y - 20, 20, basket.height + 20);
            
            // Basket rim
            basketCtx.strokeStyle = '#FF6B00';
            basketCtx.lineWidth = 5;
            basketCtx.beginPath();
            basketCtx.arc(basket.x + basket.width / 2, basket.y, basket.width / 2, 0, Math.PI, false);
            basketCtx.stroke();
            
            // Basket net
            basketCtx.strokeStyle = '#666';
            basketCtx.lineWidth = 1;
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI;
                const startX = basket.x + basket.width / 2 + Math.cos(angle) * (basket.width / 2);
                const startY = basket.y + Math.sin(angle) * (basket.width / 2);
                basketCtx.beginPath();
                basketCtx.moveTo(startX, startY);
                basketCtx.lineTo(basket.x + basket.width / 2, basket.y + basket.height);
                basketCtx.stroke();
            }
            
            // Basket label
            basketCtx.fillStyle = '#333';
            basketCtx.font = 'bold 16px Arial';
            basketCtx.textAlign = 'center';
            basketCtx.fillText('BASKET (Drag to move)', basket.x + basket.width / 2, basket.y - 30);
        }

        // Basket dragging
        basketCanvas.addEventListener('mousedown', (e) => {
            const rect = basketCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const basket = gameState.basket;
            if (x >= basket.x && x <= basket.x + basket.width &&
                y >= basket.y && y <= basket.y + basket.height) {
                isDraggingBasket = true;
                dragOffset.x = x - basket.x;
                dragOffset.y = y - basket.y;
            }
        });

        basketCanvas.addEventListener('mousemove', (e) => {
            if (!isDraggingBasket) return;
            
            const rect = basketCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left - dragOffset.x;
            const y = e.clientY - rect.top - dragOffset.y;
            
            // Keep basket within bounds
            gameState.basket.x = Math.max(0, Math.min(x, basketCanvas.width - gameState.basket.width));
            gameState.basket.y = Math.max(0, Math.min(y, basketCanvas.height - gameState.basket.height));
            
            socket.emit('move-basket', gameState.basket);
            drawBasketControl();
        });

        basketCanvas.addEventListener('mouseup', () => {
            isDraggingBasket = false;
        });

        // Update scoreboard
        function updateScoreboard() {
            const scoreboard = document.getElementById('adminScoreboard');
            scoreboard.innerHTML = '';
            
            const players = Array.from(gameState.players.values())
                .sort((a, b) => b.score - a.score);
            
            if (players.length === 0) {
                scoreboard.innerHTML = '<p>No players joined yet.</p>';
                return;
            }
            
            players.forEach((player, index) => {
                const item = document.createElement('div');
                item.className = 'score-item';
                item.style.borderLeftColor = player.color;
                item.innerHTML = `
                    <span>#${index + 1}</span>
                    <span style="color: ${player.color}">‚óè</span>
                    <span><strong>${player.name}</strong></span>
                    <span style="font-size: 1.2em; color: #667eea;"><strong>${player.score}</strong></span>
                `;
                scoreboard.appendChild(item);
            });
        }

        // Control button handlers
        document.getElementById('startRoundBtn').addEventListener('click', () => {
            socket.emit('start-round');
        });

        document.getElementById('stopRoundBtn').addEventListener('click', () => {
            socket.emit('stop-round');
        });

        document.getElementById('changeRuleBtn').addEventListener('click', () => {
            const rule = document.getElementById('ruleSelect').value;
            socket.emit('change-rule', rule);
        });

        document.getElementById('resetScoresBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to reset all scores?')) {
                socket.emit('reset-scores');
            }
        });

        document.getElementById('exportScoresBtn').addEventListener('click', () => {
            socket.emit('export-scores');
        });

        // Socket event handlers
        socket.on('connect', () => {
            socket.emit('join', { name: 'Facilitator', isFacilitator: true });
        });

        socket.on('game-state', (state) => {
            // Convert players object back to Map
            gameState.players = new Map();
            if (state.players) {
                Object.entries(state.players).forEach(([socketId, player]) => {
                    gameState.players.set(socketId, player);
                });
            }
            gameState.basket = state.basket || gameState.basket;
            gameState.roundActive = state.roundActive || false;
            gameState.roundTimeLeft = state.roundTimeLeft || 0;
            gameState.currentRule = state.currentRule || 'Normal Throw';
            
            updateScoreboard();
            updateUI();
            drawBasketControl();
        });

        socket.on('round-started', () => {
            updateUI();
        });

        socket.on('round-stopped', () => {
            updateUI();
        });

        socket.on('round-ended', () => {
            updateUI();
        });

        socket.on('timer-update', (time) => {
            gameState.roundTimeLeft = time;
            updateUI();
        });

        socket.on('rule-changed', (rule) => {
            gameState.currentRule = rule;
            document.getElementById('ruleSelect').value = rule;
        });

        socket.on('scores-export', (scores) => {
            // Convert to CSV
            let csv = 'Player Name,Score\n';
            scores.forEach(player => {
                csv += `"${player.name}",${player.score}\n`;
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `postit-dunking-scores-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        });

        function updateUI() {
            const indicator = document.getElementById('roundStatusIndicator');
            const statusText = document.getElementById('roundStatusText');
            
            if (gameState.roundActive) {
                indicator.className = 'status-indicator active';
                statusText.textContent = `Round Active - ${gameState.roundTimeLeft}s remaining`;
            } else {
                indicator.className = 'status-indicator inactive';
                statusText.textContent = 'Round Inactive';
            }
        }

        // Initialize
        drawBasketControl();
        setInterval(() => {
            drawBasketControl();
        }, 100);
    </script>
</body>
</html>

